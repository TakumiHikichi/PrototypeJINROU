package com.example.jinrou2;

import android.annotation.TargetApi;
import android.app.AlertDialog;
import android.content.DialogInterface;
import android.content.Intent;
import android.os.Build;
import android.os.Bundle;
import android.view.View;
import android.widget.Button;
import android.widget.EditText;
import android.widget.RelativeLayout;

import com.example.CharaEnum;
import com.example.MyConstants;
import com.example.jinrou2.Base.ActivityBase.GameBaseActivity;
import com.example.jinrou2.Base.ActivityBase.Lib.Act001PlayBGM;
import com.example.jinrou2.Base.ButtonBase.PlayerGameButton;
import com.example.jinrou2.Base.ButtonBase.PlayerSettingButton;
import com.example.jinrou2.Data.GameData;
import com.example.jinrou2.Data.PlayerData;
import com.example.jinrou2.Data.SettingData;

import java.util.ArrayList;
import java.util.Random;

/**
 * Created by ryouta on 2015/11/08.
 */
public class GameActivity_setting extends Act001PlayBGM implements View.OnClickListener {

    Button btn1;
    Button btn2;
    RelativeLayout layout;
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.game_field);
        Intent intent = getIntent();
        //インテントからゲームデータ取得
        GameData gd = (GameData) intent.getSerializableExtra(MyConstants.INTENT_KEY);
        //プレイヤーデータバッファ
        PlayerData pdBuf = new PlayerData();
        layout = (RelativeLayout)findViewById(R.id.game_field);
        btn1=(Button)findViewById(R.id.button1);
        btn2=(Button)findViewById(R.id.button2);
        btn1.setOnClickListener(this);
        btn2.setOnClickListener(this);
        //院展とから情報を受け取った場合、それを元にプレイヤーボタンを表示
        if(gd!=null){
            for(int i=0;i<gd.getPlayerDatas().size();i++){
                pdBuf=gd.getPlayerDatas().get(i);
                PlayerGameButton pb = new PlayerGameButton(pdBuf.getName(),(RelativeLayout)findViewById(R.id.game_field),this);
                pb.setX(pdBuf.getButtonLeft());
                pb.setY(pdBuf.getButtonTop());
                layout.addView(pb);
            }
        }
    }

    @Override
    public void onClick(View v) {
        //押されたボタン
        switch(v.getId()){
            case R.id.button1:
                final GameActivity_setting this_GA = this;
                final EditText editView = new EditText(this);
                new AlertDialog.Builder(this)
                    .setIcon(android.R.drawable.ic_dialog_info)
                    .setTitle(MyConstants.DIALOG_TITLE_MAKE_PLAYER)
                    .setView(editView)
                    .setPositiveButton(MyConstants.BTN_OK, new DialogInterface.OnClickListener() {
                        @TargetApi(Build.VERSION_CODES.JELLY_BEAN_MR1)
                        public void onClick(DialogInterface dialog, int whichButton) {
                            if (editView.getText().toString() != "") {
                                RelativeLayout layout = (RelativeLayout) findViewById(R.id.game_field);
                                PlayerSettingButton pb = new PlayerSettingButton(editView.getText().toString(),(RelativeLayout)findViewById(R.id.game_field),this_GA);
                                layout.addView(pb);
                            }
                        }
                    }).show();
                break;
            case R.id.button2:
                //役職配役用
                Random rnd = new Random();
                //参加人数
                int members=0;
                //プレイヤー情報作成
                ArrayList<PlayerData> playerList = new ArrayList();
                //ボタン情報取得
                PlayerSettingButton psBtn;
                //作成されたボタンの数をカウント
                members=layout.getChildCount();

                //プレイヤー人数毎に設定される配役情報を取得
                CharaEnum characters[] = new CharaEnum[members];
                SettingData.getSettingData(members, characters,this);

                //配役用配列
                boolean[] casts = new boolean[members];
                PlayerData pdBuf;
                //ランダム数値生成用バッファ
                int rndBuf = 0;

                //参加人数分繰り返し
                for(int i=0;i<members;i++) {
                    pdBuf=new PlayerData();
                    //子要素のボタンを取得
                    psBtn=(PlayerSettingButton) layout.getChildAt(i);
                    //ボタンの情報からプレイヤーデータを作成
                    pdBuf.setName(psBtn.getText().toString());
                    pdBuf.setButtonLeft(psBtn.getLeft());
                    pdBuf.setButtonTop(psBtn.getTop());
                    pdBuf.setButtonId(psBtn.getId());
                    //ここから配役
                    do{
                        rndBuf=rnd.nextInt(members);
                    }while(casts[rndBuf]);
                    casts[rndBuf]=true;
                    //役職決定
                    pdBuf.setChara(characters[rndBuf]);
                    playerList.add(pdBuf);
                }
                GameData gd = GameData.getInstance();
                gd.setPlayerDatas(playerList);
                Intent intent = new Intent(GameActivity_setting.this, GameActivity_confirm.class);
                intent.putExtra(MyConstants.INTENT_KEY, gd);
                startActivity(intent);
                break;
            default:
                break;
        }
    }
}
